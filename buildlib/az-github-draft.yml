# Create an empty draft to avoid race condition in distro release

parameters:
  arch:
  container:  
  demands: []

jobs:
  - job: DraftRelease_${{ parameters.arch }}
    displayName: Draft release ${{ parameters.arch }}
    container: ${{ parameters.container }}    
    pool:
      name: MLNX
      demands: ${{ parameters.demands }}
    variables:
      ${{ if eq(variables['Build.Reason'], 'ResourceTrigger') }}:
        POSTFIX: ${{ replace(variables['Build.SourceBranch'], 'refs/heads/', '') }}
      ${{ if eq(variables['Build.Reason'], 'IndividualCI') }}:
        POSTFIX: ${{ replace(variables['Build.SourceBranch'], 'refs/tags/v', '') }}
      ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
        POSTFIX: pr$(System.PullRequest.PullRequestNumber)

    steps:
    - checkout: self
      clean: true
      fetchDepth: 100
      path: "we/need/to/go/deeper"
      retryCountOnTaskFailure: 5

    - bash: ./autogen.sh
      displayName: Setup autotools

    - bash: |
        set -eEx
        # gcc --version
        ./contrib/configure-release --with-java=no
        ./contrib/buildrpm.sh -s -t -b

        # Append POSTFIX value to the source tarball filename
        find . -name "ucx-*.tar.gz" -exec sh -c '
          old_fname="$1"
          new_fname="${1%.tar.gz}-'"$POSTFIX"'.tar.gz"
          mv "$old_fname" "$new_fname"
          echo "Old filename: $old_fname"   # e.g.: ucx-1.17.0.tar.gz
          echo "New filename: $new_fname"   # e.g.: ucx-1.17.0-rc2.tar.gz
        ' _ {} \;
      displayName: Build tarball

    - task: GithubRelease@0
      condition: eq(variables['Build.Reason'], 'IndividualCI')
      displayName: Create/edit GitHub Draft Release
      inputs:
        githubConnection: release
        repositoryName: openucx/ucx
        action: edit
        tag: $(Build.SourceBranchName)
        isDraft: true
        addChangeLog: false
        releaseNotesSource: file
        releaseNotesFile: NEWS
        assetUploadMode: replace
        assets: |
          ./ucx-*.tar.gz
          ./rpm-dist/ucx-*.src.rpm
